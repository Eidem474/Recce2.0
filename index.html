<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raspberry Pi Camera</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root { --bg:#0c0f12; --panel:#141a21; --text:#e8edf2; --muted:#9fb0c0; --accent:#6bb1ff; --danger:#ff6b6b; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           background: var(--bg); color: var(--text); display: grid; grid-template-rows: auto 1fr auto; }
    header, footer { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid #1e2630; }
    footer { border-top: 1px solid #1e2630; border-bottom: none; font-size: 12px; color: var(--muted); }
    .wrap { padding: 16px; display: grid; gap: 16px; max-width: 1200px; width: 100%; margin: 0 auto; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .controls .spacer { flex: 1; }
    button, input[type="text"] {
      background: #0f141a; color: var(--text); border: 1px solid #26313d; border-radius: 10px; padding: 10px 12px;
      font-size: 14px;
    }
    button:hover { border-color: #3a4b5b; cursor: pointer; }
    .primary { border-color: #2b70c9; }
    .danger { border-color: #7a2b2b; color: #ffdede; }
    .muted { color: var(--muted); font-size: 13px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    .panel { background: var(--panel); border: 1px solid #1e2630; border-radius: 14px; padding: 12px; }
    .videoStage { position: relative; display: grid; place-items: center; background: #0b0f14; min-height: 40vh; }
    .videoStage img { max-width: 100%; height: auto; display: block; border-radius: 10px; }
    .badge {
      position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5);
      border: 1px solid #1e2630; color: var(--muted); padding: 6px 8px; border-radius: 8px; font-size: 12px;
    }
    .topRight { left: auto; right: 10px; }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .row > * { margin-right: 0; }
    .hint { font-size: 12px; color: var(--muted); }
    .error { color: var(--danger); font-weight: 600; }
    .hidden { display: none !important; }

    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 320px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content: space-between;">
      <div class="row" style="gap:10px;">
        <strong>Raspberry Pi Camera</strong>
        <span id="status" class="muted">Idle</span>
      </div>
      <div class="row">
        <button id="btnSetUrl" class="primary">Set stream URL</button>
        <button id="btnFullscreen">Fullscreen</button>
        <button id="btnSnapshot">Snapshot</button>
        <button id="btnReload">Reload</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="panel videoStage" id="stage">
        <div class="badge" id="meta">FPS: — • Size: —</div>
        <!-- Gjør URL-badge klikkbar for enkel testing -->
        <a id="conn" class="badge topRight" target="_blank" rel="noopener noreferrer">URL: not set</a>
        <img id="stream" alt="Camera stream" referrerpolicy="no-referrer" />
      </section>

      <aside class="panel">
        <h3 style="margin:6px 0 10px;">Configuration</h3>
        <div class="row">
          <input
            id="inpUrl"
            type="text"
            placeholder="Paste your ngrok HTTPS URL here (root or full path)"
            style="flex:1; min-width: 200px;"
            value="https://unfudged-controllably-leona.ngrok-free.dev/?action=stream" />
          <button id="btnSave" class="primary">Save</button>
          <button id="btnClear" class="danger">Clear</button>
        </div>
        <p class="hint" style="margin-top:8px;">
          Tip: You can also pass the stream with <code>?url=...</code> in the address bar.
          The URL is saved locally in your browser.
        </p>
        <div id="warnMixed" class="hint error hidden">
          Your stream must be <strong>HTTPS</strong> to display on this page (GitHub Pages is HTTPS).
        </div>
      </aside>
    </div>

    <section class="panel">
      <h3 style="margin:6px 0 10px;">Notes</h3>
      <ul class="muted" style="margin:0 0 6px 18px;">
        <li>mjpg-streamer vanligvis: <code>?action=stream</code>.</li>
        <li>FFmpeg sin innebygde server: ofte <code>/stream.mjpg</code>.</li>
        <li>Bruk alltid <strong>HTTPS</strong> fra ngrok på denne siden.</li>
      </ul>
    </section>
  </main>

  <footer>
    <div class="row" style="justify-content: space-between;">
      <span>Built for Spectac • Static viewer (no backend)</span>
      <span class="muted">© 2025</span>
    </div>
  </footer>

  <script>
    (function () {
      // Ikke sett en hard DEFAULT_URL (ngrok endres ofte).
      const qs = new URLSearchParams(location.search);

      const streamImg = document.getElementById('stream');
      const conn = document.getElementById('conn');
      const status = document.getElementById('status');
      const meta = document.getElementById('meta');
      const warnMixed = document.getElementById('warnMixed');
      const inpUrl = document.getElementById('inpUrl');

      const btnSave = document.getElementById('btnSave');
      const btnClear = document.getElementById('btnClear');
      const btnReload = document.getElementById('btnReload');
      const btnFullscreen = document.getElementById('btnFullscreen');
      const btnSnapshot = document.getElementById('btnSnapshot');
      const btnSetUrl = document.getElementById('btnSetUrl');
      const stage = document.getElementById('stage');

      let lastLoadTime = 0;
      let frames = 0;
      let fpsTimer = null;

      // Hjelpere
      function getSavedUrl() {
        return qs.get('url') || localStorage.getItem('raspi_stream_url') || '';
      }
      function isHttpsUrl(u) {
        try { const x = new URL(u); return x.protocol === 'https:'; } catch { return false; }
      }
      function normalizeUrl(u) {
        try {
          const url = new URL(u);
          if (location.protocol === 'https:' && url.protocol !== 'https:') url.protocol = 'https:';
          return url.toString();
        } catch { return u; }
      }
      function addTs(u) {
        return u + (u.includes('?') ? '&' : '?') + '_ts=' + Date.now();
      }
      function setConn(u) {
        conn.textContent = 'URL: ' + u;
        conn.href = u;
      }

      // Prøv automatisk begge kjente stier ved feil
      let triedVariant = false;
      function altVariant(u) {
        try {
          const url = new URL(u);
          const hasQuery = url.searchParams.toString().length > 0;
          const path = url.pathname || '/';
          // Hvis den har ?action=stream -> prøv /stream.mjpg
          if (url.searchParams.has('action')) {
            url.search = '';
            url.pathname = path.endsWith('/') ? path + 'stream.mjpg' : path + '/stream.mjpg';
            return url.toString();
          }
          // Hvis path (eller root) -> prøv ?action=stream
          url.searchParams.set('action', 'stream');
          return url.toString();
        } catch {
          // Best effort fallback bare ved string:
          if (u.includes('action=stream')) return u.replace(/\??action=stream.*$/, 'stream.mjpg');
          if (u.endsWith('/')) return u + 'stream.mjpg';
          return u + (u.includes('?') ? '&' : '?') + 'action=stream';
        }
      }

      function applyUrl(u) {
        if (!u) {
          streamImg.removeAttribute('src');
          setConn('not set');
          status.textContent = 'Idle';
          warnMixed.classList.add('hidden');
          return;
        }
        u = normalizeUrl(u);
        inpUrl.value = u;
        setConn(u);

        if (location.protocol === 'https:' && !isHttpsUrl(u)) {
          warnMixed.classList.remove('hidden');
        } else {
          warnMixed.classList.add('hidden');
        }

        triedVariant = false;   // reset fallback-state
        frames = 0;
        lastLoadTime = performance.now();
        meta.textContent = 'FPS: — • Size: —';
        status.textContent = 'Connecting…';
        streamImg.src = addTs(u);
      }

      function startFpsCounter() {
        if (fpsTimer) clearInterval(fpsTimer);
        fpsTimer = setInterval(() => {
          const now = performance.now();
          const elapsed = (now - lastLoadTime) / 1000;
          const fps = elapsed > 0 ? (frames / elapsed) : 0;
          const size = streamImg.naturalWidth && streamImg.naturalHeight
            ? (streamImg.naturalWidth + '×' + streamImg.naturalHeight)
            : '—';
          meta.textContent = 'FPS: ' + fps.toFixed(1) + ' • Size: ' + size;
          frames = 0;
          lastLoadTime = now;
        }, 1000);
      }

      // Events
      streamImg.addEventListener('load', () => {
        frames++;
        status.textContent = 'Streaming';
      });

      streamImg.addEventListener('error', () => {
        // Først fallback til alternativ sti én gang
        const current = inpUrl.value.trim();
        if (!triedVariant && current) {
          triedVariant = true;
          const alt = altVariant(current);
          inpUrl.value = alt;
          localStorage.setItem('raspi_stream_url', alt);
          setTimeout(() => applyUrl(alt), 300);
          status.textContent = 'Trying alternate path…';
          return;
        }
        status.textContent = 'Error loading stream. Retrying…';
        const u = inpUrl.value.trim();
        if (u) setTimeout(() => applyUrl(u), 1500);
      });

      btnSave.addEventListener('click', () => {
        let u = inpUrl.value.trim();
        if (!u) return;
        u = normalizeUrl(u);
        localStorage.setItem('raspi_stream_url', u);
        applyUrl(u);
      });

      btnClear.addEventListener('click', () => {
        localStorage.removeItem('raspi_stream_url');
        inpUrl.value = '';
        applyUrl('');
      });

      btnReload.addEventListener('click', () => {
        const u = getSavedUrl();
        if (u) applyUrl(u);
      });

      btnFullscreen.addEventListener('click', async () => {
        try {
          if (!document.fullscreenElement) {
            await stage.requestFullscreen();
          } else {
            await document.exitFullscreen();
          }
        } catch (e) {}
      });

      btnSnapshot.addEventListener('click', async () => {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = streamImg.naturalWidth || 1280;
          canvas.height = streamImg.naturalHeight || 720;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(streamImg, 0, 0);
          canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'snapshot_' + new Date().toISOString().replace(/[:.]/g,'-') + '.png';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
          }, 'image/png');
        } catch (e) {
          alert('Snapshot failed. Cross-origin images may block snapshots.');
        }
      });

      btnSetUrl.addEventListener('click', () => {
        setTimeout(() => inpUrl.focus(), 0);
        inpUrl.select();
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      });

      // Init
      startFpsCounter();
      const initial = normalizeUrl(getSavedUrl() || inpUrl.value.trim());
      if (initial) {
        inpUrl.value = initial;
        applyUrl(initial);
      }
    })();
  </script>
</body>
</html>
